{% extends 'chat/Base.html' %}
{% load static %}

{% block title %}PyChat - Trang ch√≠nh{% endblock %}

{% block content %}
<div class="chat-main">
  <div class="empty-chat text-center mt-5">
    <h4 class="text-muted mb-2">Ch√†o {{ curr_user.name }} üëã</h4>
    <p>Ch·ªçn m·ªôt ng∆∞·ªùi ho·∫∑c nh√≥m ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán üí¨</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
/**
 * Script n√†y ch·ªâ x·ª≠ l√Ω ph·∫ßn hi·ªÉn th·ªã v√† c·∫≠p nh·∫≠t tin nh·∫Øn m·ªõi nh·∫•t
 * cho danh s√°ch b·∫°n b√®/nh√≥m, kh√¥ng ch·∫°y WebSocket v√¨ WebSocket ƒë∆∞·ª£c
 * d√πng trong file chat ri√™ng.
 */

// --- C√ÅC H√ÄM X·ª¨ L√ù CHUNG ---

/**
 * Cu·ªôn xu·ªëng cu·ªëi danh s√°ch tin nh·∫Øn (n·∫øu c√≥ board hi·ªÉn th·ªã)
 */
function scrollToEnd() {
  const board = document.getElementById('board');
  if (board) {
    board.scrollTop = board.scrollHeight;
  }
}

/**
 * Hi·ªáu ·ª©ng s√°ng nh√≥m m·ªõi nh·∫Øn (k·∫øt n·ªëi v·ªõi group_chat.html)
 * @param {number} groupId - ID c·ªßa nh√≥m c·∫ßn t·∫°o hi·ªáu ·ª©ng.
 */
function flashGroup(groupId) {
  // S·ª≠ d·ª•ng Template Literal ƒë·ªÉ ch·ªçn ph·∫ßn t·ª≠ d·ªÖ h∆°n
  const el = document.querySelector(`.group-box[data-groupid="${groupId}"]`);
  if (el) {
    el.classList.add('flash');
    setTimeout(() => el.classList.remove('flash'), 800);
  }
}

// --- POLLING (FALLBACK KH√îNG D√ôNG WEBSOCKET) ---

/**
 * T·ª± ƒë·ªông l·∫•y tin nh·∫Øn m·ªõi m·ªói 2 gi√¢y b·∫±ng AJAX Polling.
 * (Ch·ªâ d√πng l√†m fallback khi kh√¥ng d√πng WebSocket)
 * * @param {number} senderId - ID c·ªßa ng∆∞·ªùi g·ª≠i (ng∆∞·ªùi d√πng hi·ªán t·∫°i).
 * @param {number} receiverId - ID c·ªßa ng∆∞·ªùi nh·∫≠n (b·∫°n b√®/nh√≥m).
 */
function startPolling(senderId, receiverId) {
  // Template HTML cho tin nh·∫Øn ƒë·∫øn
  const messageTemplate = `
    <div class="msg incoming">
      <div class="bubble">{description}</div>
      <div class="meta">{time}</div>
    </div>
  `;
  
  // Thi·∫øt l·∫≠p interval ƒë·ªÉ l·∫•y tin nh·∫Øn m·ªõi m·ªói 2 gi√¢y
  setInterval(() => {
    // G·ªçi API ƒë·ªÉ l·∫•y tin nh·∫Øn m·ªõi
    $.get(`/api/messages/${senderId}/${receiverId}`, function(data) {
      if (data && data.length > 0) {
        // Duy·ªát qua v√† hi·ªÉn th·ªã t·ª´ng tin nh·∫Øn
        for (let i = 0; i < data.length; i++) {
          let html = messageTemplate
            .replace('{description}', data[i].description)
            // C·∫Øt chu·ªói th·ªùi gian ƒë·ªÉ ch·ªâ l·∫•y gi·ªù v√† ph√∫t (v√≠ d·ª•: '10:30')
            .replace('{time}', data[i].time.slice(0, 5)); 
            
          $('#board').append(html);
        }
        // Cu·ªôn xu·ªëng cu·ªëi sau khi th√™m tin nh·∫Øn
        scrollToEnd();
      }
    });
  }, 2000);
}
</script>
{% endblock %}