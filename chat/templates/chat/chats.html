{% extends "chat/Base.html" %}
{% load static %}
{% load chat_extras %}
{% block title %}Chat with {{ friend.name }}{% endblock %}

{% block content %}
<div class="chat-wrapper">
  <!-- Header -->
  <div class="chat-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <img src="{% static 'images/user_image.jpg' %}" alt="avatar" class="avatar">
      <div class="friend-info">
        <h5 class="friend-name mb-0">{{ friend.name }}</h5>
        <small class="text-muted">@{{ friend.username }} ‚Ä¢ Online now</small>
      </div>
    </div>

    <div class="header-actions">
      <button id="profileBtn" class="btn btn-sm btn-outline-secondary">üë§ H·ªì s∆°</button>
      {% if friend.username %}
      <a href="{% url 'chat:clear_personal_chat' friend.username %}"
         class="btn btn-sm btn-outline-danger"
         onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ƒëo·∫°n chat v·ªõi {{ friend.name }} kh√¥ng?')">
        üóë X√≥a chat
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Chat board -->
  <div id="board" class="chat-board">
    {% for m in messages %}
      {% if m.sender_name.username == curr_user.username %}
        <div class="msg msg-out">
          <div class="bubble">
            {% if m.file %}
              {% if ".jpg" in m.file.url or ".png" in m.file.url or ".jpeg" in m.file.url %}
                <img src="{{ m.file.url }}" alt="image" class="chat-image">
              {% else %}
                {% if m.file.url|lower|endswith:".pdf" %}
                  <a href="{{ m.file.url }}" download class="file-btn pdf">üìï PDF File</a>
                {% elif m.file.url|lower|endswith:".doc" or m.file.url|lower|endswith:".docx" %}
                  <a href="{{ m.file.url }}" download class="file-btn word">üìÑ Word File</a>
                {% elif m.file.url|lower|endswith:".zip" or m.file.url|lower|endswith:".rar" %}
                  <a href="{{ m.file.url }}" download class="file-btn zip">üóú ZIP File</a>
                {% else %}
                  <a href="{{ m.file.url }}" download class="file-btn other">üìÅ File</a>
                {% endif %}

              {% endif %}
            {% endif %}
            {% if m.description %}
              <p>{{ m.description|escape }}</p>
            {% endif %}
            <span class="time">{{ m.timestamp|date:"H:i" }}</span>
          </div>
        </div>
      {% else %}
        <div class="msg msg-in">
          <div class="bubble">
            {% if m.file %}
              {% if ".jpg" in m.file.url or ".png" in m.file.url or ".jpeg" in m.file.url %}
                <img src="{{ m.file.url }}" alt="image" class="chat-image">
              {% else %}
                <a href="{{ m.file.url }}" target="_blank" class="file-link">üìÅ {{ m.file.name }}</a>
              {% endif %}
            {% endif %}
            {% if m.description %}
              <p>{{ m.description|escape }}</p>
            {% endif %}
            <span class="time">{{ m.timestamp|date:"H:i" }}</span>
          </div>
        </div>
      {% endif %}
    {% empty %}
      <p class="text-muted text-center mt-3">Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
    {% endfor %}
  </div>

  <!-- Input -->
  <form id="chat-box" class="chat-input" autocomplete="off" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="fileInput" class="file-upload">üìÅ</label>
    <input type="file" id="fileInput" name="file" accept="image/*,.pdf,.docx,.zip" hidden>
    <input type="text" id="msg_field" name="message" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button type="submit" id="send_btn">‚û§</button>
  </form>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content text-center">
    <span class="close" id="closeProfile">&times;</span>
    <img src="{% static 'images/user_image.jpg' %}" alt="avatar" class="avatar-lg mb-3">
    <h5 class="fw-bold">{{ friend.name }}</h5>
    <p class="text-muted">@{{ friend.username }}</p>
    {% if friend.bio %}
      <p class="small">{{ friend.bio }}</p>
    {% else %}
      <p class="small text-muted">Ch∆∞a c√≥ m√¥ t·∫£ b·∫£n th√¢n.</p>
    {% endif %}
    <hr>
    <p class="small"><strong>Email:</strong> {{ friend.email }}</p>
  </div>
</div>

<style>
.chat-wrapper {
  display: flex;
  flex-direction: column;
  height: 85vh;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.1);
  overflow: hidden;
}
.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid #e0e0e0;
  background: #f9f9f9;
}
.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
.friend-info { display: flex; flex-direction: column; }
.friend-name { font-weight: 600; font-size: 17px; }
.header-actions button, .header-actions a { margin-left: 5px; }

.chat-board {
  flex: 1;
  overflow-y: auto;
  background: #f5f7fa;
  padding: 18px;
  scroll-behavior: smooth;
}
.msg { display: flex; margin: 8px 0; align-items: flex-end; }
.msg-in { justify-content: flex-start; }
.msg-out { justify-content: flex-end; }
.bubble {
  background: #fff;
  border-radius: 18px;
  padding: 10px 15px;
  max-width: 72%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  word-wrap: break-word;
}
.msg-out .bubble { background: #dcf8c6; border-bottom-right-radius: 4px; }
.msg-in .bubble { background: #fff; border-bottom-left-radius: 4px; }
.bubble p { margin: 0; font-size: 15px; }
.time { display: block; text-align: right; font-size: 11px; color: #777; margin-top: 4px; }
.chat-image {
  max-width: 200px;
  max-height: 200px;
  border-radius: 8px;
  margin-bottom: 5px;
  display: block;
}
.file-link {
  display: inline-block;
  margin-bottom: 6px;
  color: #007bff;
  text-decoration: none;
}
.file-link:hover { text-decoration: underline; }

.chat-input {
  display: flex; align-items: center; padding: 10px 12px;
  border-top: 1px solid #ddd; background: #fafafa;
}
.chat-input input[type=text] {
  flex: 1; border: none; background: #fff; border-radius: 20px;
  padding: 10px 14px; font-size: 15px; outline: none;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.chat-input button {
  border: none; margin-left: 8px; width: 42px; height: 42px;
  font-size: 18px; border-radius: 50%; background: #4caf50;
  color: white; cursor: pointer; transition: 0.2s;
}
.chat-input button:hover { background: #43a047; transform: scale(1.05); }
.file-upload {
  cursor: pointer;
  font-size: 20px;
  margin-right: 8px;
}

/* ===== Modal ===== */
.modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }
.modal-content {
  position: relative; background: #fff; border-radius: 12px; width: 320px;
  margin: 8% auto; padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  animation: fadeIn 0.3s ease;
}
.avatar-lg { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
.close { position: absolute; right: 18px; top: 10px; font-size: 22px; cursor: pointer; color: #666; }
.close:hover { color: #000; }
@keyframes fadeIn { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }
</style>

{% block scripts %}
{{ block.super }}
<script>
const currUser = "{{ curr_user.username }}";
const friendUser = "{{ friend.username }}";
const board = document.getElementById("board");
const input = document.getElementById("msg_field");
const fileInput = document.getElementById("fileInput");

// ‚úÖ Preview file khi ch·ªçn
const fileLabel = document.querySelector(".file-upload");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) {
    const f = fileInput.files[0];
    let preview = "";

    if (f.type.startsWith("image/")) {
      const url = URL.createObjectURL(f);
      preview = `<img src="${url}" class="chat-image" style="max-width:120px;max-height:120px;border-radius:6px;margin-left:8px;">`;
    } else {
      preview = `<span style="font-size:13px;margin-left:8px;color:#555;">üìÅ ${f.name}</span>`;
    }

    fileLabel.innerHTML = `üìÅ${preview}`;
  } else {
    fileLabel.innerHTML = "üìÅ"; // reset n·∫øu b·ªè ch·ªçn
  }
});


function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
function fmtTime(){const d=new Date();return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');}
function scrollToEnd(){board.scrollTop=board.scrollHeight;}

function appendMsg(sender, text, time, fileUrl){
  const isMine = sender === currUser;
  let content = "";

  if(fileUrl){
    const lower = fileUrl.toLowerCase();
    const filename = fileUrl.split("/").pop();

    if(lower.endsWith(".jpg") || lower.endsWith(".png") || lower.endsWith(".jpeg")){
      content += `<img src="${fileUrl}" class="chat-image">`;
    } 
    else if(lower.endsWith(".pdf")){
      content += `<a href="${fileUrl}" download class="file-btn pdf">üìï PDF File</a>`;
    } 
    else if(lower.endsWith(".doc") || lower.endsWith(".docx")){
      content += `<a href="${fileUrl}" download class="file-btn word">üìÑ Word File</a>`;
    } 
    else if(lower.endsWith(".zip") || lower.endsWith(".rar")){
      content += `<a href="${fileUrl}" download class="file-btn zip">üóú ZIP File</a>`;
    } 
    else {
      content += `<a href="${fileUrl}" download class="file-btn other">üìÅ ${filename}</a>`;
    }
  }

  if(text) content += `<p>${escapeHtml(text)}</p>`;
  
  const html = `<div class="msg ${isMine?'msg-out':'msg-in'}"><div class="bubble">${content}<span class="time">${time}</span></div></div>`;
  board.insertAdjacentHTML("beforeend", html);
  scrollToEnd();
}


const protocol = window.location.protocol === "https:" ? "wss" : "ws";
const wsUrl = `${protocol}://${window.location.host}/ws/chat/${friendUser}/`;
const socket = new WebSocket(wsUrl);

socket.onmessage = e => {
  const data = JSON.parse(e.data);
  if (data.sender === currUser) return; // ‚õî B·ªè qua tin nh·∫Øn do ch√≠nh m√¨nh g·ª≠i
  appendMsg(data.sender, data.message, data.time || fmtTime(), data.file || null);
};

document.getElementById("chat-box").addEventListener("submit", async e=>{
  e.preventDefault();
  const text = input.value.trim();
  const file = fileInput.files[0];
  let fileUrl = null;

  if(file){
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/chat/upload/", {method:"POST", body:formData});
    const data = await res.json();
    if(data.url) fileUrl = data.url;
    fileInput.value = "";
  }

  if(!text && !fileUrl) return;
  if(socket.readyState !== WebSocket.OPEN) return console.warn("‚ö†Ô∏è WebSocket not open");

  socket.send(JSON.stringify({message:text,sender:currUser,receiver:friendUser,file:fileUrl}));
  input.value = "";
  appendMsg(currUser, text, fmtTime(), fileUrl);
  fileLabel.innerHTML = "üìÅ";
});

window.addEventListener("beforeunload",()=>{if(socket.readyState===WebSocket.OPEN)socket.close();});
scrollToEnd();

// ===== Modal logic =====
const modal = document.getElementById("profileModal");
document.getElementById("profileBtn").addEventListener("click",()=>modal.style.display="block");
document.getElementById("closeProfile").addEventListener("click",()=>modal.style.display="none");
window.addEventListener("click",e=>{if(e.target===modal)modal.style.display="none";});
</script>
{% endblock %}
{% endblock %}
