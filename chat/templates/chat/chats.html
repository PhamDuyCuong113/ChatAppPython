{% extends "chat/Base.html" %}
{% load static %}

{% block title %}Chat v·ªõi {{ friend.name }}{% endblock %}

{% block content %}
<div class="chat-wrapper">
  <!-- üîπ Header -->
  <div class="chat-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <img src="{% if friend.profile_image %}{{ friend.profile_image.url }}{% else %}{% static 'images/user_image.jpg' %}{% endif %}"
           alt="avatar" class="avatar">
      <div class="friend-info">
        <h5 class="friend-name mb-0">{{ friend.name }}</h5>
        <small class="text-muted">@{{ friend.username }}</small>
      </div>
    </div>
    <div class="header-actions">
      <button id="profileBtn" class="btn btn-sm btn-outline-secondary">üë§ H·ªì s∆°</button>
      <button id="menuToggle" class="btn btn-sm btn-outline-dark">‚ãÆ</button>
    </div>
  </div>

  <!-- üîπ Chat board -->
  <div id="board" class="chat-board">
    {% for m in messages %}
      {% ifchanged m.date_only %}
        <div class="date-separator">
          {% if m.date_only == today %}H√¥m nay{% else %}{{ m.date_only }}{% endif %}
        </div>
      {% endifchanged %}
      <div class="msg {% if m.sender == curr_user.username %}msg-out{% else %}msg-in{% endif %}" id="msg-{{ m.id|default:'' }}">
        <div class="bubble">
          {% if m.file %}
            {% with f=m.file %}
              {% if ".jpg" in f.url or ".jpeg" in f.url or ".png" in f.url %}
                <img src="{{ f.url }}" alt="{{ f.name }}" class="chat-image" loading="lazy">
              {% elif ".pdf" in f.url %}
                <a href="{{ f.url }}" target="_blank" class="file-btn pdf">üìï {{ f.name }}</a>
              {% elif ".doc" in f.url or ".docx" in f.url %}
                <a href="{{ f.url }}" target="_blank" class="file-btn word">üìÑ {{ f.name }}</a>
              {% elif ".zip" in f.url or ".rar" in f.url %}
                <a href="{{ f.url }}" target="_blank" class="file-btn zip">üóú {{ f.name }}</a>
              {% else %}
                <a href="{{ f.url }}" target="_blank" class="file-btn other">üìÅ {{ f.name }}</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          {% if m.content %}<p>{{ m.content|escape }}</p>{% endif %}
          <span class="time">{{ m.timestamp }}</span>
        </div>
      </div>
    {% empty %}
      <p class="text-muted text-center mt-3">Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
    {% endfor %}
  </div>

  <!-- üîπ Form g·ª≠i tin -->
  <form id="chat-box" class="chat-input" autocomplete="off" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="fileInput" class="file-upload">üìÅ</label>
    <input type="file" id="fileInput" hidden accept="image/*,.pdf,.docx,.zip,.rar">
    <input type="text" id="msg_field" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button type="submit" id="send_btn">‚û§</button>
  </form>
</div>

<!-- üîπ Sidebar -->
<div id="rightSidebar" class="right-sidebar">
  <div class="sidebar-header">
    <div>
      <h5 class="mb-0">{{ friend.name }}</h5>
      <small class="text-muted">@{{ friend.username }}</small>
    </div>
    <div>
      <a href="{% url 'chat:clear_personal_chat' friend.username %}"
         class="btn btn-sm btn-outline-danger me-2"
         onclick="return confirm('X√≥a to√†n b·ªô ƒëo·∫°n chat v·ªõi {{ friend.name }}?')">üóë</a>
      <button id="closeSidebar" class="btn btn-sm btn-outline-light">‚úï</button>
    </div>
  </div>
</div>

<!-- üîπ CSS -->
<style>
.chat-wrapper { display:flex; flex-direction:column; height:85vh; background:#fff; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,0.1); overflow:hidden; transition:margin-right .3s ease; }
.chat-header { padding:12px 16px; border-bottom:1px solid #e0e0e0; background:#f9f9f9; }
.avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; }
.friend-name { font-weight:600; font-size:17px; }
.chat-board { flex:1; overflow-y:auto; background:#f5f7fa; padding:18px; scroll-behavior:smooth; }
.chat-board::-webkit-scrollbar { width:6px; }
.chat-board::-webkit-scrollbar-thumb { background:#ccc; border-radius:6px; }
.chat-board::-webkit-scrollbar-thumb:hover { background:#999; }
.msg { display:flex; margin:8px 0; align-items:flex-end; }
.msg-in { justify-content:flex-start; }
.msg-out { justify-content:flex-end; }
.bubble { background:#fff; border-radius:18px; padding:10px 15px; max-width:72%; box-shadow:0 1px 3px rgba(0,0,0,0.06); word-wrap:break-word; }
.msg-out .bubble { background:#dcf8c6; border-bottom-right-radius:4px; }
.bubble p { margin:0; font-size:15px; }
.time { display:block; text-align:right; font-size:11px; color:#777; margin-top:4px; }
.chat-image { max-width:200px; max-height:200px; border-radius:8px; margin-bottom:5px; display:block; cursor:pointer; transition:transform .2s; }
.chat-image:hover { transform:scale(1.03); }
.file-btn { display:inline-block; margin-bottom:6px; padding:6px 10px; border-radius:6px; text-decoration:none; font-size:14px; color:white; }
.file-btn.pdf { background:#e53935; }
.file-btn.word { background:#1976d2; }
.file-btn.zip { background:#6d4c41; }
.file-btn.other { background:#546e7a; }
.chat-input { display:flex; align-items:center; padding:10px 12px; border-top:1px solid #ddd; background:#fafafa; }
.chat-input input[type=text] { flex:1; border:none; background:#fff; border-radius:20px; padding:10px 14px; font-size:15px; outline:none; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
.chat-input button { border:none; margin-left:8px; width:42px; height:42px; font-size:18px; border-radius:50%; background:#4caf50; color:white; cursor:pointer; transition:.2s; }
.chat-input button:hover { background:#43a047; transform:scale(1.05); }
.file-upload { cursor:pointer; font-size:20px; margin-right:8px; }
.date-separator { text-align:center; font-size:12px; color:#666; margin:10px 0; position:relative; }
.date-separator::before, .date-separator::after { content:""; position:absolute; top:50%; width:35%; height:1px; background:#ccc; }
.date-separator::before { left:0; } .date-separator::after { right:0; }
.right-sidebar { position:fixed; top:0; right:0; width:0; height:100%; background:#fff; box-shadow:-2px 0 8px rgba(0,0,0,0.2); overflow-y:auto; border-left:1px solid #ccc; transition:width .3s ease; z-index:1001; }
.right-sidebar.active { width:360px; }
.sidebar-header { display:flex; justify-content:space-between; align-items:center; padding:15px; background:#009688; color:white; }
</style>

<!-- üîπ JS -->
{% block scripts %}
{{ block.super }}
<script>
(() => {
  const currUser = "{{ curr_user.username }}";
  const friendUser = "{{ friend.username }}";
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const board = document.getElementById("board");
  const input = document.getElementById("msg_field");
  const fileInput = document.getElementById("fileInput");
  const fileLabel = document.querySelector(".file-upload");
  const sidebar = document.getElementById("rightSidebar");
  const menuBtn = document.getElementById("menuToggle");
  const closeBtn = document.getElementById("closeSidebar");
  const shownMsgs = new Set();

  // Sidebar toggle
  menuBtn.addEventListener("click", ()=>sidebar.classList.add("active"));
  closeBtn.addEventListener("click", ()=>sidebar.classList.remove("active"));

  const fmtTime = () => new Date().toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});
  const scrollToEnd = () => board.scrollTop = board.scrollHeight;
  const escapeHtml = str => !str ? "" : str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  function appendMsg(id, sender, text, time, fileUrl) {
    if (!id) id = crypto.randomUUID();
    if (shownMsgs.has(id)) return;
    shownMsgs.add(id);

    const isMine = sender === currUser;
    let content = "";

    if (fileUrl) {
      const lower = fileUrl.toLowerCase();
      const name = decodeURIComponent(fileUrl.split("/").pop());
      if (/\.(jpg|jpeg|png|gif|webp)$/i.test(lower))
        content += `<img src="${fileUrl}" class="chat-image" loading="lazy">`;
      else if (lower.endsWith(".pdf"))
        content += `<a href="${fileUrl}" target="_blank" class="file-btn pdf">üìï PDF</a>`;
      else if (/\.(doc|docx)$/i.test(lower))
        content += `<a href="${fileUrl}" target="_blank" class="file-btn word">üìÑ Word</a>`;
      else if (/\.(zip|rar|7z)$/i.test(lower))
        content += `<a href="${fileUrl}" target="_blank" class="file-btn zip">üóú ZIP</a>`;
      else
        content += `<a href="${fileUrl}" target="_blank" class="file-btn other">üìÅ ${name}</a>`;
    }

    if (text) content += `<p>${escapeHtml(text)}</p>`;
    const html = `
      <div id="msg-${id}" class="msg ${isMine ? "msg-out" : "msg-in"}">
        <div class="bubble">
          ${content}
          <span class="time">${time}</span>
        </div>
      </div>`;
    board.insertAdjacentHTML("beforeend", html);
    scrollToEnd();
  }

  // üîí Ch·∫∑n socket tr√πng
  if (window.chatSocket && window.chatSocket.readyState === WebSocket.OPEN) {
    window.chatSocket.close();
  }

  const protocol = location.protocol === "https:" ? "wss" : "ws";
  window.chatSocket = new WebSocket(`${protocol}://${location.host}/ws/chat/${friendUser}/`);
  const socket = window.chatSocket;

  socket.onopen = () => console.log("‚úÖ Connected:", friendUser);
  socket.onclose = () => console.log("üîå Disconnected");
  socket.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.error) return console.warn("‚ö†Ô∏è", data.error);
    if (data.sender === currUser) return;  // ‚úÖ tr√°nh echo
    appendMsg(data.message_id, data.sender, data.message, data.time || fmtTime(), data.file || null);
    window.moveFriendToTop(friendUser);
  };

  // üîÑ G·ª≠i tin nh·∫Øn
  const form = document.getElementById("chat-box");
  if (!form._listenerAdded) {
    form._listenerAdded = true;
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const text = input.value.trim();
      const file = fileInput.files[0];
      let fileUrl = null, msgId = crypto.randomUUID();

      if (file) {
        fileLabel.innerHTML = "‚è≥";
        const formData = new FormData();
        formData.append("file", file);
        try {
          const res = await fetch("{% url 'chat:upload_file' %}", { 
            method: "POST", 
            headers: { "X-CSRFToken": csrfToken },
            body: formData 
          });
          const data = await res.json();
          if (res.ok && data.url) fileUrl = data.url;
          else alert(data.error || "L·ªói t·∫£i file l√™n!");
        } catch (err) {
          console.error("‚ùå Upload failed:", err);
        }
        fileInput.value = "";
        fileLabel.innerHTML = "üìÅ";
      }

      if (!text && !fileUrl) return;
      const time = fmtTime();
      appendMsg(msgId, currUser, text, time, fileUrl);
      window.moveFriendToTop(friendUser);

      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          message_id: msgId,
          message: text,
          sender: currUser,
          receiver: friendUser,
          file: fileUrl,
          time
        }));
      } else {
        console.warn("‚ö†Ô∏è WebSocket ch∆∞a s·∫µn s√†ng, tin nh·∫Øn ch∆∞a g·ª≠i ƒë∆∞·ª£c");
      }

      input.value = "";
      input.focus();
    });
  }

  window.onload = () => setTimeout(scrollToEnd, 200);
})();
</script>
{% endblock scripts %}
{% endblock content %}
