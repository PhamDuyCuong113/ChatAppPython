{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}PyChat{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #f1f3f6;
      height: 100vh;
      overflow: hidden;
    }
    .chat-container { display: flex; height: 100vh; width: 100%; }

    /* Sidebar */
    .sidebar {
      width: 28%;
      min-width: 280px;
      background: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: #009688;
      color: white;
    }
    .logo-link { color: white; text-decoration: none; font-weight: 600; font-size: 20px; }
    .header-actions { display: flex; align-items: center; gap: 12px; }
    .nav-btn {
      color: white; background: transparent; border: none;
      font-size: 20px; cursor: pointer; transition: 0.2s;
    }
    .nav-btn:hover { opacity: 0.8; }

    .avatar-sm {
      width: 40px; height: 40px; border-radius: 50%;
      object-fit: cover; cursor: pointer; border: 2px solid #fff; transition: 0.2s;
    }
    .avatar-sm:hover { transform: scale(1.05); }

    .friend-list { flex: 1; overflow-y: auto; background: #fff; }
    .friend-list li {
      border-bottom: 1px solid #f2f2f2;
      transition: background 0.2s;
    }
    .friend-list li:hover { background: #f7f7f7; }
    .friend-list a {
      display: flex; align-items: center; padding: 10px 14px;
      text-decoration: none; color: #000;
    }
    .friend-list img {
      width: 44px; height: 44px; border-radius: 50%;
      margin-right: 10px; object-fit: cover;
    }
    .friend-name { font-weight: 600; margin-bottom: 2px; }
    .friend-username { font-size: 13px; color: #777; }
    .last-msg {
      font-size: 12px; color: #888;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px;
    }

    /* Chat */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f7f8fa;
      overflow: hidden;
    }
    .empty-chat { margin: auto; color: #777; text-align: center; }

    /* Modal */
    .modal {
      display: none; position: fixed; z-index: 1000; inset: 0;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background: #fff; border-radius: 10px; width: 340px;
      margin: 10% auto; padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(-10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    /* Highlight khi c√≥ tin m·ªõi */
    .friend-list li.highlight, .group-box.highlight {
      background-color: #d0f0c0 !important;
      transition: background-color 0.6s ease;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <a href="{% url 'chat:index' %}" class="logo-link">PyChat</a>
          <button class="nav-btn" id="createGroupBtn" title="T·∫°o nh√≥m">üë•</button>
        </div>

        <div class="header-actions">
          <a href="{% url 'chat:search' %}" class="nav-btn" title="T√¨m ki·∫øm b·∫°n b√®">üîç</a>

          {% if user.is_authenticated %}
          <form method="post" action="{% url 'logout' %}" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="nav-btn" title="ƒêƒÉng xu·∫•t">üö™</button>
          </form>
          {% else %}
          <a href="{% url 'login' %}" class="nav-btn">Login</a>
          <a href="/signup" class="nav-btn">Register</a>
          {% endif %}

          <a href="{% url 'chat:view_profile' username=request.user.username %}">
            <img src="{% static 'images/user_image.jpg' %}" class="avatar-sm" alt="Profile">
          </a>
        </div>
      </div>

      <!-- Sidebar List -->
      <ul class="friend-list list-group list-group-flush" id="combinedChatList">
        {% for item in combined_list %}
          {% if item.members %}
            <!-- üîπ Group -->
            <li class="list-group-item group-box" data-groupid="{{ item.id }}">
              <a href="{% url 'chat:group_chat' item.id %}">
                <img src="{% static 'images/group_icon.png' %}" alt="Group">
                <div class="d-flex flex-column">
                  <span class="friend-name">{{ item.name }}</span>
                  <span class="friend-username text-muted">{{ item.members.count }} th√†nh vi√™n</span>
                  {% if item.last_msg_time %}
                    <small class="text-muted">{{ item.last_msg_time|date:"H:i ‚Ä¢ d/m/Y" }}</small>
                  {% endif %}
                </div>
              </a>
            </li>
          {% else %}
            <!-- üîπ Friend -->
            <li class="list-group-item friend-box" data-username="{{ item.username }}">
              <a href="{% url 'chat:chat' item.username %}">
                <img src="{% static 'images/user_image.jpg' %}" alt="Avatar">
                <div class="d-flex flex-column">
                  <span class="friend-name">{{ item.name }}</span>
                  <span class="friend-username">@{{ item.username }}</span>
                  {% if item.last_msg_preview %}
                    <span class="last-msg">{{ item.last_msg_preview|truncatechars:25 }}</span>
                  {% endif %}
                </div>
              </a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <!-- Chat main area -->
   <!-- Chat main area -->
  <div class="chat-main">
    {% block content %}
    {% endblock %}
  </div>


  <!-- Modal T·∫°o Nh√≥m -->
  <div id="groupModal" class="modal">
    <div class="modal-content">
      <h5 class="mb-3 text-center">T·∫°o nh√≥m m·ªõi</h5>
      <form id="createGroupForm" method="post" action="{% url 'chat:create_group' %}">
        {% csrf_token %}
        <input type="text" name="group_name" class="form-control mb-3" placeholder="Nh·∫≠p t√™n nh√≥m..." required>

        <label class="fw-bold mb-2">Ch·ªçn th√†nh vi√™n:</label>
        <div style="max-height:150px;overflow-y:auto;">
          {% for f in user_profile.friends_set.all %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="members" value="{{ f.friend.id }}" id="m{{ f.friend.id }}">
            <label class="form-check-label" for="m{{ f.friend.id }}">{{ f.friend.name }} (@{{ f.friend.username }})</label>
          </div>
          {% empty %}
          <p class="text-muted small">Ch∆∞a c√≥ b·∫°n b√® n√†o ƒë·ªÉ th√™m v√†o nh√≥m.</p>
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-success w-100 mt-3">T·∫°o nh√≥m</button>
      </form>
    </div>
  </div>

  {% block scripts %}
  <script>
    // Modal t·∫°o nh√≥m
    document.addEventListener("DOMContentLoaded", () => {
      const groupModal = document.getElementById("groupModal");
      const createGroupBtn = document.getElementById("createGroupBtn");
      if (createGroupBtn && groupModal) {
        createGroupBtn.addEventListener("click", () => groupModal.style.display = "block");
        window.addEventListener("click", e => {
          if (e.target === groupModal) groupModal.style.display = "none";
        });
      }
    });

    // Khi c√≥ tin nh·∫Øn m·ªõi => di chuy·ªÉn b·∫°n b√® ho·∫∑c nh√≥m l√™n ƒë·∫ßu
    window.moveFriendToTop = function(identifier) {
      const list = document.getElementById("combinedChatList");
      const item = list.querySelector(`[data-username='${identifier}'], [data-groupid='${identifier}']`);
      if (item) {
        list.prepend(item);
        item.classList.add("highlight");
        setTimeout(() => item.classList.remove("highlight"), 800);
      }
    };
  </script>
  {% endblock %}
</body>
</html>
